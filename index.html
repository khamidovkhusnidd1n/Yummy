<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yummy - Premium Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="menu_data.js?v=1769508120.8934684"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --accent: #dc2626;
        }

        body {
            font-family: 'Outfit', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background: #fcfcfc;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .dark body {
            background: #0c0c0c;
            color: white;
        }

        .category-active {
            background: var(--accent) !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.4);
        }

        .product-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.03);
            width: 100%;
            height: 100%;
        }

        .dark .product-card {
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .product-card:active {
            transform: scale(0.95);
        }

        .price-tag {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .category-btn {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .category-btn:active {
            transform: scale(0.9);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
        }

        .dark .glass {
            background: rgba(15, 15, 15, 0.7);
        }

        .image-zoom {
            transition: transform 0.8s cubic-bezier(0.2, 0, 0.2, 1);
        }

        .product-card:hover .image-zoom {
            transform: scale(1.1);
        }

        .sticky-cats {
            background: rgba(252, 252, 252, 0.9);
            backdrop-filter: blur(10px);
            z-index: 30;
        }

        .dark .sticky-cats {
            background: rgba(12, 12, 12, 0.9);
        }

        .animate-item {
            animation: slideUp 0.6s cubic-bezier(0.2, 0, 0.2, 1) both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .promo-card {
            position: relative;
            border-radius: 38px;
            overflow: hidden;
            min-height: 220px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: #000;
            box-shadow: 0 25px 45px -35px rgba(0, 0, 0, 0.6);
        }

        .promo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.7s cubic-bezier(0.2, 0, 0.2, 1);
        }

        .promo-card:hover img {
            transform: scale(1.03);
        }

        .promo-card-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0.9) 100%);
        }

        .promo-card:active,
        .product-card:active {
            transform: scale(0.95);
        }

        .promo-card,
        .product-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
        }

        .promo-card-badge {
            font-size: 10px;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            font-weight: 900;
            border-radius: 999px;
            padding: 0.25rem 1rem;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .promo-card-price {
            font-size: 1.2rem;
            line-height: 1.2;
            font-weight: 900;
            color: #fff;
        }

        .promo-card-secondary {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>

<body class="pb-32">
    <!-- Header -->
    <header
        class="fixed top-0 left-0 right-0 z-50 glass border-b border-gray-100 dark:border-zinc-800 px-6 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-red-600">YUMMY</h1>
        </div>
        <div class="flex gap-3">
            <button id="search-toggle"
                class="w-10 h-10 rounded-2xl bg-gray-100 dark:bg-zinc-800 flex items-center justify-center">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.3-4.3" />
                </svg>
            </button>
            <button id="cart-btn"
                class="relative w-10 h-10 rounded-2xl bg-black dark:bg-white text-white dark:text-black flex items-center justify-center">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path d="M4 4h2l3 12h10l3-9H7" />
                </svg>
                <span id="cart-count"
                    class="absolute -top-1.5 -right-1.5 bg-red-600 text-[10px] font-black text-white w-5 h-5 rounded-full flex items-center justify-center border-2 border-white dark:border-zinc-900 hidden">0</span>
            </button>
        </div>
    </header>

    <!-- Search Box -->
    <div id="search-container" class="fixed top-20 left-0 right-0 z-40 px-6 py-4 hidden animate-item">
        <input type="text" id="search-input" placeholder="Search..."
            class="w-full h-14 bg-white dark:bg-zinc-900 rounded-3xl px-6 font-bold shadow-2xl border-2 border-red-500/20 focus:border-red-500 outline-none transition-all">
    </div>

    <!-- Featured -->
    <section class="mt-28 px-6">
        <div id="promo-grid" class="mt-6 grid grid-cols-2 gap-3"></div>
    </section>

    <!-- Categories -->
    <div id="categories-container"
        class="sticky top-[72px] left-0 right-0 py-4 px-6 flex gap-3 overflow-x-auto no-scrollbar sticky-cats scroll-px-6 snap-x">
    </div>

    <!-- Menu -->
    <div id="menu-sections" class="mt-6 space-y-8 pb-12 w-full flex flex-col"></div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 z-[60] hidden">
        <div id="cart-overlay"
            class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-500"></div>
        <div id="cart-sheet"
            class="absolute bottom-0 left-0 right-0 bg-white dark:bg-[#0f0f0f] rounded-t-[50px] min-h-[70vh] p-8 translate-y-full transition-transform duration-500 flex flex-col">
            <div class="w-16 h-1.5 bg-gray-200 dark:bg-zinc-800 rounded-full mx-auto mb-8"></div>
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 id="cart-title" class="text-3xl font-black tracking-tight">Cart</h2>
                    <p id="cart-sub" class="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Your
                        selected items</p>
                </div>
                <button id="clear-cart" class="text-red-500 font-black text-xs uppercase tracking-wider">Clear</button>
            </div>
            <div id="cart-items" class="flex-grow space-y-6 overflow-y-auto max-h-[40vh] pr-2"></div>
            <div class="mt-10 border-t border-gray-100 dark:border-zinc-800 pt-8">
                <input type="text" id="promo-input" placeholder="Promo code"
                    class="w-full h-14 bg-gray-50 dark:bg-zinc-900 rounded-3xl px-6 font-bold outline-none mb-6 uppercase">
                <div id="cart-total" class="flex justify-between items-end mb-8"></div>
                <button id="checkout-btn"
                    class="w-full h-18 py-5 price-tag rounded-[30px] font-black text-white text-lg shadow-2xl shadow-red-500/40 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <span id="order-btn-text">PLACE ORDER</span>
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                        <path d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const urlParams = new URLSearchParams(window.location.search);
        const STORAGE_KEY = 'yummy_lang';
        const DELIVERY_THRESHOLD = 50000;
        const BASE_DELIVERY_FEE = 15000;
        const SUPPORTED_LANGS = ['uz', 'ru', 'en'];
        const queryLang = urlParams.get('lang');
        let persistedLang = null;
        try { persistedLang = localStorage.getItem(STORAGE_KEY); } catch (error) { persistedLang = null; }
        let CURRENT_LANG = (queryLang || persistedLang || 'uz').toLowerCase().split('-')[0];
        if (!SUPPORTED_LANGS.includes(CURRENT_LANG)) CURRENT_LANG = 'uz';
        try { localStorage.setItem(STORAGE_KEY, CURRENT_LANG); } catch (error) { }

        const LANG_STRINGS = {
            uz: {
                'search_placeholder': 'Qanday taom qidiramiz? 🔎',
                'top_choice': 'TOP TANLOV',
                'featured_title': 'Bugun nima yeymiz?',
                'featured_sub': 'Barcha taomlar 100% tabiiy va mazali!',
                'not_found': 'Hech nima topilmadi... ☕️',
                'cart_title': 'Savat',
                'cart_sub': 'Siz tanlagan mazali taomlar',
                'cart_empty': 'Savatingiz bo\'sh 🛒',
                'food_label': 'Taomlar',
                'deliv_label': 'Yetkazish',
                'order_btn': 'BUYURTMA BERISH',
                'confirm_btn': 'TASDIQLASH',
                'promo_placeholder': 'Promo kod (ixtiyoriy)',
                'cats': {
                    "🌯 Lavash": "🌯 Lavash", "🍔 Burger": "🍔 Burger", "🥙 Doner": "🥙 Doner",
                    "🍗 KFC": "🍗 KFC", "🌭 Xot-dog": "🌭 Xot-dog", "🥪 Xaggi": "🥪 Xaggi",
                    "🍗 Naggets": "🍗 Naggets", "🧀 Pishloqli yostiqchalar": "🧀 Pishloqli yostiqchalar",
                    "🥪 Klab sandwich": "🥪 Klab", "🍟 Fri": "🍟 Fri", "🥟 Somsa": "🥟 Somsa",
                    "☕️ Ichimliklar": "☕️ Ichimliklar", "🍹 Cocktails": "🍹 Cocktails",
                    "🔥 Specials": "🔥 Maxsus", "🥫 Souslar": "🥫 Souslar"
                },
                'delivery_fee_label': '(bepul)',
                'delivery_free': '50 000 so'mdan ortiq yetkazish bepul!',
                'delivery_fee_note': '50 000 so'mgacha yetkazish 15 000 so'm'
            },
            ru: {
                'search_placeholder': '??? ????? ??????? ??',
                'top_choice': '??? ?????',
                'featured_title': '??? ?????? ????????',
                'featured_sub': '??? ???????? 100% ???????????!',
                'not_found': '?????? ?? ???????... ??',
                'cart_title': '???????',
                'cart_sub': '???? ????????? ?????',
                'cart_empty': '??????? ????? ??',
                'food_label': '?????',
                'deliv_label': '????????',
                'order_btn': '???????? ?????',
                'confirm_btn': '???????????',
                'promo_placeholder': '???????? (?????????????)',
                'cats': {
                    "?? Lavash": "?? ?????", "?? Burger": "?? ??????", "?? Doner": "?? ?????",
                    "?? KFC": "?? KFC", "?? Xot-dog": "?? ???-???", "?? Xaggi": "?? ?????",
                    "?? Naggets": "?? ????????", "?? Pishloqli yostiqchalar": "?? ?????? ?????????",
                    "?? Klab sandwich": "?? ????", "?? Fri": "?? ???", "?? Somsa": "?? ?????",
                    "?? Ichimliklar": "?? ???????", "?? Cocktails": "?? ????????",
                    "?? Specials": "?? ?????", "?? Souslar": "?? ?????"
                },
                'delivery_fee_label': '(бесплатно)',
                'delivery_free': 'Доставка бесплатна от 50 000 сум!',
                'delivery_fee_note': 'Доставка до 50 000 сум стоит 15 000 сум'
            },
            en: {
                'search_placeholder': 'What are we looking for? 🔎',
                'top_choice': 'TOP CHOICE',
                'featured_title': 'What shall we eat today?',
                'featured_sub': 'All ingredients are 100% natural!',
                'not_found': 'Nothing found... ☕️',
                'cart_title': 'Cart',
                'cart_sub': 'Your selected items',
                'cart_empty': 'Your cart is empty 🛒',
                'food_label': 'Food',
                'deliv_label': 'Delivery',
                'order_btn': 'PLACE ORDER',
                'confirm_btn': 'CONFIRM',
                'promo_placeholder': 'Promo code (optional)',
                'cats': {
                    "🌯 Lavash": "🌯 Lavash", "🍔 Burger": "🍔 Burger", "🥙 Doner": "🥙 Doner",
                    "🍗 KFC": "🍗 KFC", "🌭 Xot-dog": "🌭 Hot-dog", "🥪 Xaggi": "🥪 Haggi",
                    "🍗 Naggets": "🍗 Nuggets", "🧀 Pishloqli yostiqchalar": "🧀 Cheese pillows",
                    "🥪 Klab sandwich": "🥪 Club", "🍟 Fri": "🍟 Fries", "🥟 Somsa": "🥟 Somsa",
                    "☕️ Ichimliklar": "☕️ Drinks", "🍹 Cocktails": "🍹 Cocktails",
                    "🔥 Specials": "🔥 Specials", "🥫 Souslar": "🥫 Sauces"
                },
                'delivery_fee_label': '(free)',
                'delivery_free': 'Delivery free over 50,000 so'm!',
                'delivery_fee_note': 'Delivery up to 50,000 so'm costs 15,000 so'm'
            }
        };

        const ITEM_NAMES = {
            ru: {
                "Standart": "Стандарт", "Pishloqli": "С сыром", "Big": "Большой", "Big pishloq": "Большой с сыром",
                "Big (45sm)": "Большой (45 см)", "Canada (45sm)": "Канада (45 см)", "Super (45sm)": "Супер (45 см)",
                "Chiz": "Сырный", "Gamburger": "Гамбургер", "Chizburger": "Чизбургер", "Double": "Дабл",
                "Double chiz": "Дабл чиз", "Go'shtli": "С мясом", "Pishloqli tovuq": "Сырная курица",
                "Nuggets": "Наггетсы", "Nuggets mini": "Наггетсы мини", "File strips": "Стрипсы",
                "Qanot": "Крылышки", "Kartoshka": "Картошка фри", "Lunch box": "Ланч-бокс", "Mini": "Мини",
                "Twins": "Твинс", "Sous": "Соус", "Yostiqchalar": "Подушечки", "Yostiqchalar mini": "Подушечки мини",
                "Choy": "Чай", "Choy mevali": "Фруктовый чай", "O'rmon mevalari": "Лесные ягоды", "Ko'k": "Синий",
                "Kofe": "Кофе", "Kofe (Big)": "Кофе (большой)", "Moxito": "Мохито", "Tropic": "Тропик",
                "Xot let": "Горячий латте", "Kfc xaggi": "KFC Хагги", "Kfc BURGER (+0.25 Cola)": "KFC БУРГЕР (+0.25 Кола)",
                "Kfc HAGGI (+0.25 Cola)": "KFC ХАГГИ (+0.25 Кола)"
            },
            en: {
                "Standart": "Standard", "Pishloqli": "Cheese", "Big": "Big", "Big pishloq": "Big cheese",
                "Big (45sm)": "Big (45 cm)", "Canada (45sm)": "Canada (45 cm)", "Super (45sm)": "Super (45 cm)",
                "Chiz": "Cheese", "Gamburger": "Hamburger", "Chizburger": "Cheeseburger", "Double": "Double",
                "Double chiz": "Double cheese", "Go'shtli": "Meat", "Pishloqli tovuq": "Cheesy chicken",
                "Nuggets": "Nuggets", "Nuggets mini": "Nuggets mini", "File strips": "Fillet strips",
                "Qanot": "Wings", "Kartoshka": "Fries", "Lunch box": "Lunch box", "Mini": "Mini",
                "Twins": "Twins", "Sous": "Sauce", "Yostiqchalar": "Cheese pillows", "Yostiqchalar mini": "Mini cheese pillows",
                "Choy": "Tea", "Choy mevali": "Fruit tea", "O'rmon mevalari": "Forest berries", "Ko'k": "Blue",
                "Kofe": "Coffee", "Kofe (Big)": "Coffee (Large)", "Moxito": "Mojito", "Tropic": "Tropical",
                "Xot let": "Hot latte", "Kfc xaggi": "KFC Haggi", "Kfc BURGER (+0.25 Cola)": "KFC BURGER (+0.25 Cola)",
                "Kfc HAGGI (+0.25 Cola)": "KFC HAGGI (+0.25 Cola)"
            }
        };

        const PROMO_ITEMS = [
            {
                id: 'promo_kfc_combo',
                name: 'Kfc BURGER',
                price: 33000,
                image: 'images/image2/kfc_burger.png',
                badge: 'Combo',
                label: 'Kfc BURGER',
                subtext: "33 000 so'm",
                secondary: "0.25 Cola bilan"
            },
            {
                id: 'promo_shourma',
                name: 'SHOURMA',
                price: 15000,
                image: 'images/shourma_promo.jpg',
                badge: 'Yangi',
                label: 'SHOURMA',
                subtext: "15 000 / 30 000",
                secondary: ""
            }
        ];

        const PROMO_CODES = {
            'YUMMY10': { discount: 10, type: 'percent' },
            'YUMMY5000': { discount: 5000, type: 'fixed' },
            'WELCOME': { discount: 15, type: 'percent' }
        };

        function validatePromoCode(code) {
            if (!code) return { valid: false, discount: 0 };
            const promo = PROMO_CODES[code.toUpperCase()];
            if (!promo) return { valid: false, discount: 0 };
            return { valid: true, ...promo };
        }

        function calculateDiscount(total, promoResult) {
            if (!promoResult.valid) return 0;
            if (promoResult.type === 'percent') {
                return Math.floor(total * promoResult.discount / 100);
            }
            return promoResult.discount;
        }

        const S = LANG_STRINGS[CURRENT_LANG] || LANG_STRINGS['uz'];

        // Apply translations to static elements
        document.getElementById('search-input').placeholder = S.search_placeholder;
        document.getElementById('cart-title').innerText = S.cart_title;
        document.getElementById('cart-sub').innerText = S.cart_sub;
        document.getElementById('checkout-btn').querySelector('span').innerText = S.order_btn;
        document.getElementById('promo-input').placeholder = S.promo_placeholder;

        const MENU_DATA = {
            "🌯 Lavash": [
                { "n": "Standart", "p": 30000, "i": "images/lavash.png" },
                { "n": "Pishloqli", "p": 35000, "i": "images/lavash.png" },
                { "n": "Big", "p": 40000, "i": "images/lavash.png" },
                { "n": "Big pishloq", "p": 45000, "i": "images/lavash.png" }
            ],
            "🍔 Burger": [
                { "n": "Gamburger", "p": 28000, "i": "images/burger.png" },
                { "n": "Chizburger", "p": 33000, "i": "images/burger.png" },
                { "n": "Double", "p": 35000, "i": "images/double_burger.png" },
                { "n": "Double chiz", "p": 40000, "i": "images/double_burger.png" }
            ],
            "🥙 Doner": [
                { "n": "Standart", "p": 25000, "i": "images/image2/donar.png" },
                { "n": "Big", "p": 30000, "i": "images/image2/donar.png" },
                { "n": "Chiz", "p": 35000, "i": "images/image2/donar.png" }
            ],
            "🍗 KFC": [
                { "n": "File strips", "p": 90000, "i": "images/kfc_strips.png" },
                { "n": "Qanot", "p": 85000, "i": "images/kfc_wings.png" },
                { "n": "Lunch box", "p": 30000, "i": "images/kfc_lunch.png" },
                { "n": "Kfc xaggi", "p": 30000, "i": "images/image2/xaggi.png" }
            ],
            "🌭 Xot-dog": [
                { "n": "Mini", "p": 10000, "i": "images/image2/hot_dog.png" },
                { "n": "Twins", "p": 17000, "i": "images/image2/hot_dog.png" },
                { "n": "Big (45sm)", "p": 22000, "i": "images/image2/hot_dog.png" },
                { "n": "Super (45sm)", "p": 25000, "i": "images/image2/hot_dog.png" },
                { "n": "Canada (45sm)", "p": 25000, "i": "images/hotdog_canada.png" }
            ],
            "🥪 Xaggi": [
                { "n": "Standart", "p": 35000, "i": "images/image2/xaggi.png" },
                { "n": "Big", "p": 45000, "i": "images/image2/xaggi.png" },
                { "n": "Xot let", "p": 28000, "i": "images/image2/xaggi.png" }
            ],
            "🍗 Naggets": [
                { "n": "Nuggets", "p": 22000, "i": "images/naggets.png" },
                { "n": "Nuggets mini", "p": 11000, "i": "images/naggets.png" }
            ],
            "🧀 Pishloqli yostiqchalar": [
                { "n": "Yostiqchalar", "p": 28000, "i": "images/pishloqli.png" },
                { "n": "Yostiqchalar mini", "p": 14000, "i": "images/pishloqli.png" }
            ],
            "🥪 Klab sandwich": [
                { "n": "Standart", "p": 35000, "i": "images/sandwich.png" }
            ],
            "🍟 Fri": [
                { "n": "Standart", "p": 15000, "i": "images/fri.png" },
                { "n": "Big", "p": 17000, "i": "images/fri.png" }
            ],
            "🥟 Somsa": [
                { "n": "Go'shtli", "p": 10000, "i": "images/somsa.png" },
                { "n": "Pishloqli tovuq", "p": 7000, "i": "images/somsa.png" },
                { "n": "Ko'k", "p": 5000, "i": "images/somsa.png" },
                { "n": "Kartoshka", "p": 5000, "i": "images/somsa.png" }
            ],
            "☕️ Ichimliklar": [
                { "n": "Choy", "p": 3000, "i": "images/image2/tea.png" },
                { "n": "Kofe", "p": 5000, "i": "images/image2/coffee.png" },
                { "n": "Kofe (Big)", "p": 7000, "i": "images/image2/coffee.png" },
                { "n": "Choy mevali", "p": 10000, "i": "images/image2/tea_via_fruits.png" }
            ],
            "🍹 Cocktails": [
                { "n": "Tropic", "p": 15000, "i": "images/image2/tropic.png" },
                { "n": "Moxito", "p": 15000, "i": "images/image2/moxito.png" },
                { "n": "O'rmon mevalari", "p": 15000, "i": "images/image2/forest_fruits.png" }
            ],
            "🔥 Specials": [
                { "n": "Kfc BURGER (+0.25 Cola)", "p": 33000, "i": "images/image2/kfc_burger.png" },
                { "n": "Kfc HAGGI (+0.25 Cola)", "p": 38000, "i": "images/image2/kfc_haggi_cola.png" }
            ],
            "🥫 Souslar": [
                { "n": "Sous", "p": 4000, "i": "images/image2/sous.png" }
            ]
        };

        // --- DYNAMIC DATA INTEGRATION ---
        if (window.DYNAMIC_MENU_DATA) {
            // Apply dynamic menu data
            Object.assign(MENU_DATA, window.DYNAMIC_MENU_DATA);

            // Apply dynamic translations
            if (window.DYNAMIC_CATS) {
                if (window.DYNAMIC_CATS.uz) Object.assign(LANG_STRINGS.uz.cats, window.DYNAMIC_CATS.uz);
                if (window.DYNAMIC_CATS.ru) Object.assign(LANG_STRINGS.ru.cats, window.DYNAMIC_CATS.ru);
                if (window.DYNAMIC_CATS.en) Object.assign(LANG_STRINGS.en.cats, window.DYNAMIC_CATS.en);
            }

            // Clear items not in dynamic data (optional, but effectively we act as if MENU_DATA is the source)
            // Ideally we would replace MENU_DATA entirely:
            Object.keys(MENU_DATA).forEach(key => delete MENU_DATA[key]);
            Object.assign(MENU_DATA, window.DYNAMIC_MENU_DATA);
        }
        // -------------------------------

        function translate(key, type = 'item') {
            if (type === 'cat') return S.cats[key] || key;
            const dict = ITEM_NAMES[CURRENT_LANG] || {};
            const cleanKey = String(key).trim();
            return dict[cleanKey] || cleanKey;
        }

        let cart = [];
        let idCounter = 1;
        const FLAT_ITEMS = [];
        const CATEGORIES = Object.keys(MENU_DATA);
        let currentCategoryIndex = 0;
        let isLoadingMore = false;
        let paginationMode = false;

        Object.keys(MENU_DATA).forEach(cat => {
            MENU_DATA[cat].forEach(item => {
                FLAT_ITEMS.push({ id: idCounter++, raw_name: item.n, price: item.p, image: item.i, cat });
            });
        });

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = Object.keys(MENU_DATA).map(cat => {
                const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
                return `
                    <button id="nav-${safeId}" onclick="selectCategory('${cat}')" 
                        class="category-btn whitespace-nowrap px-8 py-3.5 rounded-3xl text-sm font-black tracking-tight transition-all bg-gray-100 dark:bg-zinc-800 text-gray-500 dark:text-zinc-500">
                        ${translate(cat, 'cat')}
                    </button>
                `;
            }).join('');
        }

        function renderCategorySection(cat) {
            const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
            return `
                <div id="section-${safeId}" class="menu-section mb-10" data-category="${cat}">
                    <div class="px-6 mb-4">
                        <h2 class="text-xl font-black tracking-tighter text-gray-900 dark:text-white flex items-center gap-2">
                            <span class="w-1 h-6 bg-red-600 rounded-full"></span>
                            ${translate(cat, 'cat')}
                        </h2>
                    </div>
                    <div class="px-6 grid grid-cols-2 gap-3">
                        ${MENU_DATA[cat].map(item => renderProductCard(item)).join('')}
                    </div>
                </div>
            `;
        }

        function renderMenu(searchTerm = "") {
            const container = document.getElementById('menu-sections');
            if (searchTerm) {
                paginationMode = false;
                const filtered = FLAT_ITEMS.filter(i => translate(i.raw_name).toLowerCase().includes(searchTerm.toLowerCase()));
                container.innerHTML = `<div class="px-6 grid grid-cols-2 gap-4">${filtered.map(item => renderProductCard(item)).join('')}</div>`;
                if (!filtered.length) container.innerHTML = `<div class="py-20 text-center text-gray-400 font-bold">${S.not_found}</div>`;
                return;
            }

            paginationMode = true;
            currentCategoryIndex = 0;
            container.innerHTML = '';

            // Load all categories at once
            for (let i = 0; i < CATEGORIES.length; i++) {
                const cat = CATEGORIES[i];
                const html = renderCategorySection(cat);
                container.innerHTML += html;
            }
            currentCategoryIndex = CATEGORIES.length;

            setTimeout(initScrollSpy, 100);
        }

        function loadMoreMenus(count = 2) {
            // No longer needed with new approach, but kept for compatibility
            if (isLoadingMore || !paginationMode) return;
            isLoadingMore = false;
        }

        function renderProductCard(item) {
            const rawName = item.raw_name || item.n;
            const name = translate(rawName);
            const price = item.p || item.price;
            const img = item.i || item.image;
            return `
                <div class="product-card bg-white dark:bg-[#1a1a1a] rounded-[45px] p-3 shadow-xl shadow-black/5 flex flex-col justify-between w-full h-full">
                    <div class="relative w-full aspect-square bg-gray-50 dark:bg-zinc-800 rounded-[38px] overflow-hidden">
                        <img src="${img}" onerror="this.onerror=null; this.src='images/burger.png';" class="w-full h-full object-cover image-zoom">
                        <button onclick="addToCartByName('${name.replace(/'/g, "\\'")}', ${price}, '${img}')" class="absolute bottom-2 right-2 w-9 h-9 price-tag rounded-full shadow-md shadow-red-500/30 flex items-center justify-center text-white active:scale-90 transition-all hover:scale-110">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3.5" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                        </button>
                    </div>
                    <div class="px-4 py-5">
                        <h3 class="font-black text-[12px] leading-tight tracking-tight text-gray-800 dark:text-zinc-100 line-clamp-2 h-8">${name}</h3>
                        <p class="text-red-500 font-extrabold text-[15px] mt-1 tracking-tighter">${price.toLocaleString()} so'm</p>
                    </div>
                </div>
            `;
        }

        function renderPromoCard(item) {
            const priceText = item.price ? item.price.toLocaleString() + " so'm" : '';
            return `
                <div class="promo-card" onclick="handlePromoClick('${item.id}')">
                    <img src="${item.image}" alt="${item.name}">
                    <div class="promo-card-overlay">
                        <div>
                            <span class="promo-card-badge">${item.badge}</span>
                        </div>
                        <div>
                            <p class="text-white text-base font-black mb-0.5">${item.label}</p>
                            <p class="promo-card-price">${priceText}</p>
                            <p class="text-[10px] text-white/70 font-bold">${item.subtext}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPromoGrid() {
            const container = document.getElementById('promo-grid');
            if (!container) return;
            container.innerHTML = PROMO_ITEMS.map(item => renderPromoCard(item)).join('');
        }

        window.handlePromoClick = (promoId) => {
            const promo = PROMO_ITEMS.find(item => item.id === promoId);
            if (!promo) return;
            addToCartByName(promo.label, promo.price, promo.image);
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        };

        window.addToCartByName = (name, price, image) => {
            const inCart = cart.find(i => i.name === name);
            if (inCart) inCart.quantity += 1;
            else cart.push({ name, price, image, quantity: 1, id: Date.now() });
            updateCartUI();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }

        let isScrollingByClick = false;
        window.selectCategory = (cat) => {
            isScrollingByClick = true;
            updateActiveCategoryUI(cat);
            const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
            const el = document.getElementById(`section-${safeId}`);
            if (el) {
                const y = el.getBoundingClientRect().top + window.pageYOffset - 140;
                window.scrollTo({ top: y, behavior: "smooth" });
            }
            setTimeout(() => { isScrollingByClick = false; }, 800);
            if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function updateActiveCategoryUI(cat) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('category-active');
                btn.classList.add('bg-gray-100', 'dark:bg-zinc-800', 'text-gray-500', 'dark:text-zinc-500');
            });
            const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
            const activeBtn = document.getElementById(`nav-${safeId}`);
            if (activeBtn) {
                activeBtn.classList.add('category-active');
                activeBtn.classList.remove('bg-gray-100', 'dark:bg-zinc-800', 'text-gray-500', 'dark:text-zinc-500');
                activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        function initScrollSpy() {
            const sections = document.querySelectorAll('.menu-section');
            const observer = new IntersectionObserver((entries) => {
                if (isScrollingByClick) return;
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.3) {
                        updateActiveCategoryUI(entry.target.getAttribute('data-category'));
                    }
                });
            }, { rootMargin: '-100px 0px -60% 0px' });
            sections.forEach(s => observer.observe(s));
        }

        const HEADER_OFFSET = 140;
        const AUTO_SCROLL_THRESHOLD = 200;
        let autoLastScrollY = window.scrollY;
        let autoScrollTimer = null;
        let autoScrolling = false;
        let lastAutoAdvanceTime = 0;

        function getNearestSection() {
            const sections = Array.from(document.querySelectorAll('.menu-section'));
            if (!sections.length) return null;
            let best = sections[0];
            let bestDist = Math.abs(best.getBoundingClientRect().top - HEADER_OFFSET);
            for (const sec of sections) {
                const rect = sec.getBoundingClientRect();
                const dist = Math.abs(rect.top - HEADER_OFFSET);
                if (dist < bestDist) { bestDist = dist; best = sec; }
            }
            return best;
        }

        function scrollToSection(section) {
            if (!section) return;
            autoScrolling = true;
            const y = section.offsetTop - HEADER_OFFSET;
            window.scrollTo({ top: y, behavior: 'smooth' });
            setTimeout(() => { autoScrolling = false; }, 1200);
        }

        function autoAdvanceIfNeeded() {
            if (isScrollingByClick || autoScrolling) return;
            const now = Date.now();
            // Increased minimum time between auto-advances (2 seconds)
            if (now - lastAutoAdvanceTime < 2500) return;

            const dirDown = window.scrollY > autoLastScrollY;
            autoLastScrollY = window.scrollY;
            if (!dirDown) return;

            const current = getNearestSection();
            if (!current) return;

            const bottomPosition = current.offsetTop + current.offsetHeight;
            const viewportBottom = window.scrollY + window.innerHeight;

            // Increased threshold so scroll completes fully before advancing
            if (viewportBottom < bottomPosition - AUTO_SCROLL_THRESHOLD) return;

            const sections = Array.from(document.querySelectorAll('.menu-section'));
            const idx = sections.indexOf(current);
            const next = idx >= 0 && idx < sections.length - 1 ? sections[idx + 1] : null;

            if (next) {
                lastAutoAdvanceTime = now;
                scrollToSection(next);
            }
        }

        window.addEventListener('scroll', () => {
            clearTimeout(autoScrollTimer);
            // Increased debounce delay from 200 to 400ms
            autoScrollTimer = setTimeout(autoAdvanceIfNeeded, 400);
        }, { passive: true });

        function updateCartUI() {
            const count = cart.reduce((sum, i) => sum + i.quantity, 0);
            const countEl = document.getElementById('cart-count');
            if (count > 0) {
                countEl.innerText = count;
                countEl.classList.remove('hidden');
                tg.MainButton.setText(`${S.confirm_btn} (${count})`);
                tg.MainButton.show();
                tg.MainButton.setParams({ color: '#dc2626', text_color: '#ffffff' });
            } else {
                countEl.classList.add('hidden');
                tg.MainButton.hide();
            }

            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            const deliveryFee = total >= DELIVERY_THRESHOLD ? 0 : BASE_DELIVERY_FEE;
            const finalTotal = total > 0 ? total + deliveryFee : 0;
            const deliveryMessage = total >= DELIVERY_THRESHOLD ? S.delivery_free : S.delivery_fee_note;

            document.getElementById('cart-total').innerHTML = `<div class="text-right"><p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">${S.food_label}: ${total.toLocaleString()} so'm</p><p class="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-2">${S.deliv_label}: ${deliveryFee.toLocaleString()} so'm</p><p class="text-4xl font-black tracking-tighter text-red-600">${finalTotal.toLocaleString()} so'm</p><p class="text-[10px] font-bold uppercase tracking-widest mt-2 ${total >= DELIVERY_THRESHOLD ? 'text-emerald-500' : 'text-yellow-500'}">${deliveryMessage}</p></div>`;
        }
        const modal = document.getElementById('cart-modal'),
            sheet = document.getElementById('cart-sheet'),
            overlay = document.getElementById('cart-overlay');

        function openCart() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                overlay.style.opacity = "1";
                sheet.classList.remove('translate-y-full');
            }, 10);
            renderCartItems();
        }
        function closeCart() {
            overlay.style.opacity = "0";
            sheet.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 500);
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            let total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            if (cart.length === 0) {
                container.innerHTML = `<div class="py-10 text-center text-gray-400 font-bold">${S.cart_empty}</div>`;
            }
            else {
                container.innerHTML = cart.map(item => `
                    <div class="flex items-center gap-5 animate-item">
                        <div class="w-16 h-16 rounded-2xl bg-gray-100 dark:bg-zinc-800 overflow-hidden shrink-0 shadow-md"><img src="${item.image}" class="w-full h-full object-cover"></div>
                        <div class="grow">
                            <h4 class="font-bold text-sm leading-tight text-gray-900 dark:text-white">${item.name}</h4>
                            <p class="text-red-500 font-extrabold text-sm mt-1">${item.price.toLocaleString()} so'm</p>
                        </div>
                        <div class="flex items-center gap-2 bg-gradient-to-r from-red-50 to-orange-50 dark:from-zinc-800 dark:to-zinc-700 rounded-2xl p-2 shadow-sm">
                            <button onclick="changeQty(${item.id}, -1)" class="w-8 h-8 rounded-lg bg-white dark:bg-zinc-600 shadow-sm flex items-center justify-center font-bold text-red-500 dark:text-red-400 hover:bg-red-50 dark:hover:bg-zinc-500 transition-colors">−</button>
                            <span class="text-sm font-black w-6 text-center text-gray-900 dark:text-white">${item.quantity}</span>
                            <button onclick="changeQty(${item.id}, 1)" class="w-8 h-8 rounded-lg bg-white dark:bg-zinc-600 shadow-sm flex items-center justify-center font-bold text-red-500 dark:text-red-400 hover:bg-red-50 dark:hover:bg-zinc-500 transition-colors">+</button>
                        </div>
                    </div>
                `).join('');
            }

            const deliveryFee = 15000;
            const foodTotal = total;
            const promoCode = document.getElementById('promo-input').value.trim().toUpperCase();
            const promoResult = validatePromoCode(promoCode);
            const discount = calculateDiscount(foodTotal, promoResult);
            const finalTotal = foodTotal > 0 ? foodTotal + deliveryFee - discount : 0;

            let discountHTML = '';
            if (promoResult.valid && discount > 0) {
                discountHTML = `<p class="text-[11px] text-green-500 font-bold uppercase mb-1">✓ Chegirma: -${discount.toLocaleString()} so'm</p>`;
            }

            document.getElementById('cart-total').innerHTML = `<div class="text-right">
                <p class="text-[10px] text-gray-500 font-bold uppercase mb-1">${S.food_label}: ${foodTotal.toLocaleString()} so'm</p>
                <p class="text-[10px] text-amber-600 dark:text-amber-400 font-bold uppercase mb-1">${S.deliv_label}: ${deliveryFee.toLocaleString()} so'm</p>
                ${discountHTML}
                <p class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-red-500 mt-2">${finalTotal.toLocaleString()} so'm</p>
            </div>`;
        }

        window.changeQty = (id, delta) => {
            const idx = cart.findIndex(i => i.id === id);
            cart[idx].quantity += delta;
            if (cart[idx].quantity <= 0) cart.splice(idx, 1);
            renderCartItems(); updateCartUI();
            if (cart.length === 0) closeCart();
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        document.getElementById('cart-btn').onclick = openCart;
        overlay.onclick = closeCart;
        document.getElementById('clear-cart').onclick = () => { cart = []; updateCartUI(); closeCart(); };
        document.getElementById('checkout-btn').onclick = () => {
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            const promoCode = document.getElementById('promo-input').value.trim().toUpperCase();
            const promoResult = validatePromoCode(promoCode);
            const discount = calculateDiscount(total, promoResult);
            const deliveryFee = 15000;
            const finalTotal = total > 0 ? total + deliveryFee - discount : 0;

            // Show promo validation dialog if code entered
            if (promoCode && !promoResult.valid) {
                alert('❌ Noto\'g\'ri promo kod!');
                return;
            }

            // Show confirmation with promo details
            let confirmMsg = `📋 Buyurtma tasdiqlash:\n\n`;
            confirmMsg += `🍔 Taomlar: ${total.toLocaleString()} so'm\n`;
            confirmMsg += `🚚 Yetkazish: ${deliveryFee.toLocaleString()} so'm\n`;
            if (promoResult.valid && discount > 0) {
                confirmMsg += `✅ Chegirma: -${discount.toLocaleString()} so'm\n`;
            }
            confirmMsg += `\n💰 Jami: ${finalTotal.toLocaleString()} so'm`;

            if (!confirm(confirmMsg)) return;

            const payload = {
                type: 'order',
                items: cart,
                total: finalTotal,
                promo_code: promoCode || null,
                discount: discount,
                delivery_fee: deliveryFee,
                food_total: total
            };

            const send = () => {
                document.getElementById('checkout-btn').disabled = true;
                document.getElementById('checkout-btn').innerHTML = '<span>YUBORISH...</span>';
                setTimeout(() => {
                    tg.sendData(JSON.stringify(payload));
                    tg.close();
                }, 500);
            };

            try {
                const cached = localStorage.getItem('yummy_last_geo');
                if (cached) payload.location = JSON.parse(cached);
            } catch (e) { }

            if (!navigator.geolocation) return send();

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    payload.location = {
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        accuracy: pos.coords.accuracy,
                        ts: Date.now()
                    };
                    try {
                        localStorage.setItem('yummy_last_geo', JSON.stringify(payload.location));
                    } catch (e) { }
                    send();
                },
                () => send(),
                { enableHighAccuracy: true, timeout: 4000 }
            );
        };

        tg.onEvent('mainButtonClicked', openCart);
        document.getElementById('search-toggle').onclick = () => {
            const box = document.getElementById('search-container');
            box.classList.toggle('hidden');
            if (!box.classList.contains('hidden')) document.getElementById('search-input').focus();
        }
        document.getElementById('search-input').oninput = (e) => renderMenu(e.target.value);

        tg.expand();
        tg.ready();
        if (tg.colorScheme === 'dark') {
            document.documentElement.classList.add('dark');
            tg.setHeaderColor('#0f0f0f');
            tg.setBackgroundColor('#0c0c0c');
        }

        renderCategories();
        renderPromoGrid();
        renderMenu();
    </script>
</body>

</html>