<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="Yummy - Premium Food Delivery Service. Order delicious food online with fast delivery. 🍔🌮🍜">
    <meta name="keywords" content="food delivery, restaurant, online order, fast food">
    <meta name="author" content="Yummy Delivery">
    <meta name="theme-color" content="#dc2626">
    <meta property="og:title" content="Yummy - Premium Delivery">
    <meta property="og:description" content="Order delicious food with fast delivery">
    <meta property="og:image" content="https://yummy.uz/og-image.jpg">
    <title>Yummy - Premium Food Delivery | Order Online Now</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="menu_data.js?v=1769524000"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="utils.js?v=1769524000"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <script>
        // Early theme init to prevent white flash
        (function() {
            const THEME_STORAGE_KEY = 'yummy_theme';
            try {
                const saved = localStorage.getItem(THEME_STORAGE_KEY);
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (saved === 'dark' || (!saved && prefersDark)) {
                    document.documentElement.classList.add('dark');
                }
            } catch (e) { /* ignore */ }
        })();
    </script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --accent: #dc2626;
        }

        html.dark,
        .dark body {
            background: #0c0c0c;
            color: white;
        }

        body {
            font-family: 'Outfit', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background: #fcfcfc;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        .category-active {
            background: var(--accent) !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.4);
        }

        .product-card {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.03);
            width: 100%;
            height: 100%;
        }

        .dark .product-card {
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .product-card:active {
            transform: scale(0.95);
        }

        .price-tag {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .category-btn {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .category-btn:active {
            transform: scale(0.9);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
        }

        .dark .glass {
            background: rgba(15, 15, 15, 0.7);
        }

        .image-zoom {
            transition: transform 0.8s cubic-bezier(0.2, 0, 0.2, 1);
        }

        .product-card:hover .image-zoom {
            transform: scale(1.1);
        }

        .sticky-cats {
            background: rgba(252, 252, 252, 0.9);
            backdrop-filter: blur(10px);
            z-index: 30;
        }

        .dark .sticky-cats {
            background: rgba(12, 12, 12, 0.9);
        }

        .animate-item {
            animation: slideUp 0.6s cubic-bezier(0.2, 0, 0.2, 1) both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .promo-card {
            position: relative;
            border-radius: 38px;
            overflow: hidden;
            min-height: 220px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: #000;
            box-shadow: 0 25px 45px -35px rgba(0, 0, 0, 0.6);
        }

        .promo-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.7s cubic-bezier(0.2, 0, 0.2, 1);
        }

        .promo-card:hover img {
            transform: scale(1.03);
        }

        .promo-card-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0.9) 100%);
        }

        .promo-card:active,
        .product-card:active {
            transform: scale(0.95);
        }

        .promo-card,
        .product-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
        }

        .promo-card-badge {
            font-size: 10px;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            font-weight: 900;
            border-radius: 999px;
            padding: 0.25rem 1rem;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .promo-card-price {
            font-size: 1.2rem;
            line-height: 1.2;
            font-weight: 900;
            color: #fff;
        }

        .promo-card-secondary {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* ===== SEARCH IMPROVEMENTS ===== */
        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
            border-bottom: 2px solid #dc2626;
        }

        .dark .search-results-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border-bottom-color: #ef4444;
        }

        .back-to-menu-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 999px;
            font-weight: 900;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
        }

        .back-to-menu-btn:hover {
            background: #b91c1c;
            transform: translateX(-4px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .back-to-menu-btn:active {
            transform: scale(0.95);
        }

        .search-filter-chips {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark .search-filter-chips {
            border-top-color: rgba(255, 255, 255, 0.1);
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dark .filter-chip {
            background: #1f2937;
            color: #d1d5db;
            border-color: #374151;
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
            transform: scale(1.05);
        }

        .search-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            dark: #0f0f0f;
            border-radius: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
            margin-top: 0.5rem;
        }

        .dark .search-autocomplete {
            background: #1a1a1a;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dark .autocomplete-item {
            border-bottom-color: #1f2937;
        }

        .autocomplete-item:hover {
            background: #f9fafb;
        }

        .dark .autocomplete-item:hover {
            background: #1f2937;
        }

        .autocomplete-icon {
            width: 32px;
            height: 32px;
            border-radius: 0.75rem;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .dark .autocomplete-icon {
            background: #2d2d2d;
        }

        /* ===== MOBILE RESPONSIVENESS ===== */
        @media (max-width: 640px) {
            .promo-card {
                min-height: 180px;
            }

            .promo-card-overlay {
                padding: 0.75rem;
            }

            .promo-card-badge {
                font-size: 9px;
                padding: 0.2rem 0.75rem;
            }

            .promo-card-price {
                font-size: 1rem;
            }

            .category-btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }

            #search-input {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .product-card {
                border-radius: 2rem;
            }

            .product-card img {
                border-radius: 1.5rem;
            }

            button {
                min-height: 44px;
                /* Touch-friendly */
                min-width: 44px;
            }

            .quantity-btn {
                width: 36px;
                height: 36px;
            }

            .back-to-menu-btn {
                padding: 0.625rem 1.25rem;
                font-size: 0.8125rem;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .promo-card {
                min-height: 240px;
            }

            .category-btn {
                padding: 0.625rem 1.25rem;
                font-size: 0.875rem;
            }

            .product-card {
                border-radius: 2.5rem;
            }

            #menu-sections {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
                padding: 0 1rem;
            }
        }

        @media (min-width: 1025px) {
            .promo-card {
                min-height: 280px;
            }

            .promo-grid-desktop {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .category-btn {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }

            .product-card {
                border-radius: 3rem;
            }
        }

        /* ===== DARK MODE TEXT CONTRAST ===== */
        .dark .product-card h3 {
            color: #f5f5f5;
            /* AAA standard - Minimum 7:1 ratio */
            font-weight: 900;
        }

        .dark .product-card p {
            color: #fca5a5;
            /* AAA standard for prices */
        }

        .dark .category-btn {
            color: #a3a3a3;
        }

        .dark .category-btn:hover {
            color: #e5e5e5;
        }

        .dark input::placeholder {
            color: #707070;
            /* AAA contrast for placeholder */
        }

        .dark a {
            color: #60a5fa;
            /* Better link visibility */
        }

        .dark button {
            color: #ffffff;
        }

        .dark h1,
        .dark h2,
        .dark h3,
        .dark h4 {
            color: #f9fafb;
        }

        .dark .menu-section h2 {
            color: #f0f0f0;
        }

        /* ===== NIGHT MODE ICON ===== */
        .theme-toggle-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.4);
            transition: all 0.3s ease;
            z-index: 40;
        }

        .dark .theme-toggle-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
        }

        .theme-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 32px rgba(251, 191, 36, 0.6);
        }

        .theme-toggle-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 640px) {
            .theme-toggle-btn {
                width: 48px;
                height: 48px;
                bottom: 1.5rem;
                right: 1.5rem;
                font-size: 1.25rem;
            }
        }

        /* ===== ENHANCED PROMO SCROLL ===== */
        #promo-grid {
            scroll-behavior: smooth;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        #promo-grid::-webkit-scrollbar {
            height: 4px;
        }

        #promo-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        #promo-grid::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 2px;
        }

        /* ===== ACCESSIBILITY ===== */
        button:focus,
        input:focus,
        a:focus {
            outline: 3px solid #dc2626;
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>

<body class="pb-32">
    <!-- Header -->
    <header
        class="fixed top-0 left-0 right-0 z-50 glass border-b border-gray-100 dark:border-zinc-800 px-6 py-4 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-red-600">YUMMY</h1>
        </div>
        <div class="flex gap-3">
            <button id="search-toggle"
                class="w-10 h-10 rounded-2xl bg-gray-100 dark:bg-zinc-800 flex items-center justify-center">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.3-4.3" />
                </svg>
            </button>
            <button id="cart-btn"
                class="relative w-10 h-10 rounded-2xl bg-black dark:bg-white text-white dark:text-black flex items-center justify-center">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path d="M4 4h2l3 12h10l3-9H7" />
                </svg>
                <span id="cart-count"
                    class="absolute -top-1.5 -right-1.5 bg-red-600 text-[10px] font-black text-white w-5 h-5 rounded-full flex items-center justify-center border-2 border-white dark:border-zinc-900 hidden">0</span>
            </button>
        </div>
    </header>

    <!-- Search Box (Enhanced) -->
    <div id="search-container" class="fixed top-20 left-0 right-0 z-40 px-6 py-4 hidden animate-item">
        <div class="relative">
            <input type="text" id="search-input" placeholder="Search..."
                class="w-full h-14 bg-white dark:bg-zinc-900 rounded-3xl px-6 font-bold shadow-2xl border-2 border-red-500/20 focus:border-red-500 outline-none transition-all">
            <div id="search-autocomplete" class="search-autocomplete hidden"></div>
        </div>
        <div id="search-filters" class="search-filter-chips hidden"></div>
    </div>

    <!-- Search Results Header (Hidden by default) -->
    <div id="search-results-header" class="search-results-header hidden mt-20 mb-4">
        <div>
            <h2 class="text-xl font-black text-gray-900 dark:text-white">Search Results</h2>
            <p id="search-result-count" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Found items</p>
        </div>
        <button id="back-to-menu" class="back-to-menu-btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M15 19l-7-7 7-7" />
            </svg>
            Back to Menu
        </button>
    </div>

    <!-- Featured -->
    <section class="mt-28 px-6">
        <div id="promo-grid" class="mt-6 grid grid-cols-2 gap-3"></div>
    </section>

    <!-- Categories -->
    <div id="categories-container"
        class="sticky top-[72px] left-0 right-0 py-4 px-6 flex gap-3 overflow-x-auto no-scrollbar sticky-cats scroll-px-6 snap-x">
    </div>

    <!-- Menu -->
    <div id="menu-sections" class="mt-6 space-y-8 pb-12 w-full flex flex-col"></div>

    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="theme-toggle-btn" title="Toggle dark mode" aria-label="Toggle dark mode">
        <span id="theme-icon">🌙</span>
    </button>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 z-[60] hidden">
        <div id="cart-overlay"
            class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-500"></div>
        <div id="cart-sheet"
            class="absolute bottom-0 left-0 right-0 bg-white dark:bg-[#0f0f0f] rounded-t-[50px] min-h-[70vh] p-8 translate-y-full transition-transform duration-500 flex flex-col">
            <div class="w-16 h-1.5 bg-gray-200 dark:bg-zinc-800 rounded-full mx-auto mb-8"></div>
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 id="cart-title" class="text-3xl font-black tracking-tight">Cart</h2>
                    <p id="cart-sub" class="text-xs text-gray-400 font-bold uppercase tracking-widest mt-1">Your
                        selected items</p>
                </div>
                <button id="clear-cart" class="text-red-500 font-black text-xs uppercase tracking-wider">Clear</button>
            </div>
            <div id="cart-items" class="flex-grow space-y-6 overflow-y-auto max-h-[40vh] pr-2"></div>
            <div class="mt-10 border-t border-gray-100 dark:border-zinc-800 pt-8">
                <div id="cart-total" class="flex justify-between items-end mb-8"></div>
                <button id="checkout-btn"
                    class="w-full h-18 py-5 price-tag rounded-[30px] font-black text-white text-lg shadow-2xl shadow-red-500/40 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <span id="order-btn-text">PLACE ORDER</span>
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                        <path d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp ?? null;
        const safeTelegramCall = (callback) => {
            if (!tg || typeof callback !== 'function') return;
            try {
                callback(tg);
            } catch (err) {
                console.warn('Telegram API error:', err);
            }
        };
        const urlParams = new URLSearchParams(window.location.search);
        const STORAGE_KEY = 'yummy_lang';
        const DELIVERY_THRESHOLD = 50000;
        const BASE_DELIVERY_FEE = 15000;
        const SUPPORTED_LANGS = ['uz', 'ru', 'en'];
        const safeGetById = (id) => document.getElementById(id);
        const queryLang = urlParams.get('lang');
        let persistedLang = null;
        try { persistedLang = localStorage.getItem(STORAGE_KEY); } catch (error) { persistedLang = null; }
        let CURRENT_LANG = (queryLang || persistedLang || 'uz').toLowerCase().split('-')[0];
        if (!SUPPORTED_LANGS.includes(CURRENT_LANG)) CURRENT_LANG = 'uz';
        try { localStorage.setItem(STORAGE_KEY, CURRENT_LANG); } catch (error) { }

        const LANG_STRINGS = {
            uz: {
                'search_placeholder': 'Qanday taom qidiramiz? 🔎',
                'top_choice': 'TOP TANLOV',
                'featured_title': 'Bugun nima yeymiz?',
                'featured_sub': 'Barcha taomlar 100% tabiiy va mazali!',
                'not_found': 'Hech nima topilmadi... ☕️',
                'cart_title': 'Savat',
                'cart_sub': 'Siz tanlagan mazali taomlar',
                'cart_empty': 'Savatingiz bo\'sh 🛒',
                'food_label': 'Taomlar',
                'deliv_label': 'Yetkazish',
                'order_btn': 'BUYURTMA BERISH',
                'confirm_btn': 'TASDIQLASH',
                'promo_placeholder': 'Promo kod (ixtiyoriy)',
                'cats': {
                    "🌯 Lavash": "🌯 Lavash", "🍔 Burger": "🍔 Burger", "🥙 Doner": "🥙 Doner",
                    "🍗 KFC": "🍗 KFC", "🌭 Xot-dog": "🌭 Xot-dog", "🥪 Xaggi": "🥪 Xaggi",
                    "🍗 Naggets": "🍗 Naggets", "🧀 Pishloqli yostiqchalar": "🧀 Pishloqli yostiqchalar",
                    "🥪 Klab sandwich": "🥪 Klab", "🍟 Fri": "🍟 Fri", "🥟 Somsa": "🥟 Somsa",
                    "☕️ Ichimliklar": "☕️ Ichimliklar", "🍹 Cocktails": "🍹 Cocktails",
                    "🔥 Specials": "🔥 Maxsus", "🥫 Souslar": "🥫 Souslar"
                },
                'delivery_fee_label': '(bepul)',
                'delivery_free': "50 000 so'mdan ortiq yetkazish bepul!",
                'delivery_fee_note': "50 000 so'mgacha yetkazish 15 000 so'm"
            },
            ru: {
                'search_placeholder': 'Что будем искать? 🔎',
                'top_choice': 'ТОП ВЫБОР',
                'featured_title': 'Что поедим сегодня?',
                'featured_sub': 'Все продукты 100% натуральные!',
                'not_found': 'Ничего не найдено... ☕️',
                'cart_title': 'Корзина',
                'cart_sub': 'Ваши выбранные блюда',
                'cart_empty': 'Корзина пуста 🛒',
                'food_label': 'Блюда',
                'deliv_label': 'Доставка',
                'order_btn': 'ОФОРМИТЬ ЗАКАЗ',
                'confirm_btn': 'ПОДТВЕРДИТЬ',
                'promo_placeholder': 'Промокод (необязательно)',
                'cats': {
                    "🌯 Lavash": "🌯 Лаваш", "🍔 Burger": "🌯 Бургер", "🥙 Doner": "🥙 Донер",
                    "🍗 KFC": "🍗 KFC", "🌭 Xot-dog": "🌭 Хот-дог", "🥪 Xaggi": "🥪 Хагги",
                    "🍗 Naggets": "🍗 Наггетсы", "🧀 Pishloqli yostiqchalar": "🧀 Сырные подушечки",
                    "🥪 Klab sandwich": "🥪 Клаб", "🍟 Fri": "🍟 Фри", "🥟 Somsa": "🥟 Сомса",
                    "☕️ Ichimliklar": "☕️ Напитки", "🍹 Cocktails": "🍹 Коктейли",
                    "🔥 Specials": "🔥 Акции", "🥫 Souslar": "🥫 Соусы"
                },
                'delivery_fee_label': '(бесплатно)',
                'delivery_free': 'Доставка бесплатна от 50 000 сум!',
                'delivery_fee_note': 'Доставка до 50 000 сум стоит 15 000 сум'
            },
            en: {
                'search_placeholder': 'What are we looking for? 🔎',
                'top_choice': 'TOP CHOICE',
                'featured_title': 'What shall we eat today?',
                'featured_sub': 'All ingredients are 100% natural!',
                'not_found': 'Nothing found... ☕️',
                'cart_title': 'Cart',
                'cart_sub': 'Your selected items',
                'cart_empty': 'Your cart is empty 🛒',
                'food_label': 'Food',
                'deliv_label': 'Delivery',
                'order_btn': 'PLACE ORDER',
                'confirm_btn': 'CONFIRM',
                'promo_placeholder': 'Promo code (optional)',
                'cats': {
                    "🌯 Lavash": "🌯 Lavash", "🍔 Burger": "🍔 Burger", "🥙 Doner": "🥙 Doner",
                    "🍗 KFC": "🍗 KFC", "🌭 Xot-dog": "🌭 Hot-dog", "🥪 Xaggi": "🥪 Haggi",
                    "🍗 Naggets": "🍗 Nuggets", "🧀 Pishloqli yostiqchalar": "🧀 Cheese pillows",
                    "🥪 Klab sandwich": "🥪 Club", "🍟 Fri": "🍟 Fries", "🥟 Somsa": "🥟 Somsa",
                    "☕️ Ichimliklar": "☕️ Drinks", "🍹 Cocktails": "🍹 Cocktails",
                    "🔥 Specials": "🔥 Specials", "🥫 Souslar": "🥫 Sauces"
                },
                'delivery_fee_label': '(free)',
                'delivery_free': "Delivery free over 50,000 so'm!",
                'delivery_fee_note': "Delivery up to 50,000 so'm costs 15,000 so'm"
            }
        };

        const ITEM_NAMES = {
            ru: {
                "Standart": "Стандарт", "Pishloqli": "С сыром", "Big": "Большой", "Big pishloq": "Большой с сыром",
                "Big (45sm)": "Большой (45 см)", "Canada (45sm)": "Канада (45 см)", "Super (45sm)": "Супер (45 см)",
                "Chiz": "Сырный", "Gamburger": "Гамбургер", "Chizburger": "Чизбургер", "Double": "Дабл",
                "Double chiz": "Дабл чиз", "Go'shtli": "С мясом", "Pishloqli tovuq": "Сырная курица",
                "Nuggets": "Наггетсы", "Nuggets mini": "Наггетсы мини", "File strips": "Стрипсы",
                "Qanot": "Крылышки", "Kartoshka": "Картошка фри", "Lunch box": "Ланч-бокс", "Mini": "Мини",
                "Twins": "Твинс", "Sous": "Соус", "Yostiqchalar": "Подушечки", "Yostiqchalar mini": "Подушечки мини",
                "Choy": "Чай", "Choy mevali": "Фруктовый чай", "O'rmon mevalari": "Лесные ягоды", "Ko'k": "Синий",
                "Kofe": "Кофе", "Kofe (Big)": "Кофе (большой)", "Moxito": "Мохито", "Tropic": "Тропик",
                "Xot let": "Горячий латте", "Kfc xaggi": "KFC Хагги", "Kfc BURGER (+0.25 Cola)": "KFC БУРГЕР (+0.25 Кола)",
                "Kfc HAGGI (+0.25 Cola)": "KFC ХАГГИ (+0.25 Кола)"
            },
            en: {
                "Standart": "Standard", "Pishloqli": "Cheese", "Big": "Big", "Big pishloq": "Big cheese",
                "Big (45sm)": "Big (45 cm)", "Canada (45sm)": "Canada (45 cm)", "Super (45sm)": "Super (45 cm)",
                "Chiz": "Cheese", "Gamburger": "Hamburger", "Chizburger": "Cheeseburger", "Double": "Double",
                "Double chiz": "Double cheese", "Go'shtli": "Meat", "Pishloqli tovuq": "Cheesy chicken",
                "Nuggets": "Nuggets", "Nuggets mini": "Nuggets mini", "File strips": "Fillet strips",
                "Qanot": "Wings", "Kartoshka": "Fries", "Lunch box": "Lunch box", "Mini": "Mini",
                "Twins": "Twins", "Sous": "Sauce", "Yostiqchalar": "Cheese pillows", "Yostiqchalar mini": "Mini cheese pillows",
                "Choy": "Tea", "Choy mevali": "Fruit tea", "O'rmon mevalari": "Forest berries", "Ko'k": "Blue",
                "Kofe": "Coffee", "Kofe (Big)": "Coffee (Large)", "Moxito": "Mojito", "Tropic": "Tropical",
                "Xot let": "Hot latte", "Kfc xaggi": "KFC Haggi", "Kfc BURGER (+0.25 Cola)": "KFC BURGER (+0.25 Cola)",
                "Kfc HAGGI (+0.25 Cola)": "KFC HAGGI (+0.25 Cola)"
            }
        };

        const PROMO_ITEMS = [
            {
                id: 'promo_kfc_combo',
                name: 'Kfc BURGER',
                price: 33000,
                image: 'images/image2/kfc_burger.png',
                badge: 'Combo',
                label: 'Kfc BURGER',
                subtext: "33 000 so'm",
                secondary: "0.25 Cola bilan"
            },
            {
                id: 'promo_shourma',
                name: 'SHOURMA',
                price: 15000,
                image: 'images/shourma_promo.jpg',
                badge: 'Yangi',
                label: 'SHOURMA',
                subtext: "15 000 / 30 000",
                secondary: ""
            }
        ];

        // ===== DISCOUNT SYSTEM =====
        function calculateQuantityDiscount(itemCount) {
            if (itemCount >= 5) return 10; // 10% discount
            if (itemCount >= 2) return 5;  // 5% discount
            return 0;
        }

        function applyQuantityDiscount(total, itemCount) {
            const discountPercent = calculateQuantityDiscount(itemCount);
            return Math.floor(total * discountPercent / 100);
        }

        const ENHANCED_PROMO_CODES = {
            'YUMMY10': { discount: 10, type: 'percent', minAmount: 0, description: '10% off any order' },
            'YUMMY5000': { discount: 5000, type: 'fixed', minAmount: 25000, description: '5000 so\'m off orders over 25000' },
            'WELCOME': { discount: 15, type: 'percent', minAmount: 0, description: '15% welcome bonus', firstTimeOnly: true },
            'FRIEND20': { discount: 20, type: 'percent', minAmount: 50000, description: '20% off orders over 50000' },
            'LUNCH50': { discount: 50, type: 'fixed', minAmount: 0, description: '50 so\'m off lunch (11-14)' }
        };

        function validatePromoCode(code, total, isFirstTime = false) {
            if (!code) return { valid: false, discount: 0, message: '' };
            const promo = ENHANCED_PROMO_CODES[code.toUpperCase()];
            if (!promo) return { valid: false, discount: 0, message: '❌ Invalid promo code' };
            if (total < promo.minAmount) {
                return { valid: false, discount: 0, message: `❌ Minimum order ${promo.minAmount.toLocaleString()} so'm` };
            }
            if (promo.firstTimeOnly && !isFirstTime) {
                return { valid: false, discount: 0, message: '❌ First-time users only' };
            }
            if (code.toUpperCase() === 'LUNCH50') {
                const hour = new Date().getHours();
                if (hour < 11 || hour >= 14) {
                    return { valid: false, discount: 0, message: '❌ Lunch offer 11:00-14:00 only' };
                }
            }
            return { valid: true, ...promo, message: `✅ ${promo.description}` };
        }

        function calculateFinalDiscount(total, promoCode, quantityCount, isFirstTime = false) {
            const promoResult = validatePromoCode(promoCode, total, isFirstTime);
            let totalDiscount = 0;
            if (quantityCount >= 2) {
                totalDiscount += applyQuantityDiscount(total, quantityCount);
            }
            if (promoResult.valid) {
                let promoDiscount = 0;
                if (promoResult.type === 'percent') {
                    promoDiscount = Math.floor((total - totalDiscount) * promoResult.discount / 100);
                } else {
                    promoDiscount = promoResult.discount;
                }
                totalDiscount += promoDiscount;
            }
            return { totalDiscount, promoResult };
        }

        function calculateDeliveryFee(subtotal, distance, zone) {
            if (subtotal >= DELIVERY_THRESHOLD) return { fee: 0, isFree: true, reason: S.delivery_free };
            let fee = BASE_DELIVERY_FEE;
            if (distance && distance > 3) {
        const _cb = document.getElementById('checkout-btn');
        if (_cb) {
            const _span = _cb.querySelector('span');
            if (_span) _span.innerText = S.order_btn;
        }
        const _pi = document.getElementById('promo-input');
        if (_pi) _pi.placeholder = S.promo_placeholder;

        const searchResultsHeader = safeGetById('search-results-header');
        const searchFilters = safeGetById('search-filters');
        const searchResultCount = safeGetById('search-result-count');

        // MENU_DATA is loaded from menu_data.js

        // --- DYNAMIC DATA INTEGRATION ---
        if (window.DYNAMIC_MENU_DATA) {
            // Apply dynamic menu data
            Object.assign(MENU_DATA, window.DYNAMIC_MENU_DATA);

            // Apply dynamic translations
            if (window.DYNAMIC_CATS) {
                if (window.DYNAMIC_CATS.uz) Object.assign(LANG_STRINGS.uz.cats, window.DYNAMIC_CATS.uz);
                if (window.DYNAMIC_CATS.ru) Object.assign(LANG_STRINGS.ru.cats, window.DYNAMIC_CATS.ru);
                if (window.DYNAMIC_CATS.en) Object.assign(LANG_STRINGS.en.cats, window.DYNAMIC_CATS.en);
            }

            // Clear items not in dynamic data (optional, but effectively we act as if MENU_DATA is the source)
            // Ideally we would replace MENU_DATA entirely:
            Object.keys(MENU_DATA).forEach(key => delete MENU_DATA[key]);
            Object.assign(MENU_DATA, window.DYNAMIC_MENU_DATA);
        }
        // -------------------------------

        function translate(key, type = 'item') {
            if (type === 'cat') return S.cats[key] || key;
            const dict = ITEM_NAMES[CURRENT_LANG] || {};
            const cleanKey = String(key).trim();
            return dict[cleanKey] || cleanKey;
        }

        let cart = [];
        let idCounter = 1;
        const FLAT_ITEMS = [];
        const CATEGORIES = Object.keys(MENU_DATA);
        let currentCategoryIndex = 0;
        let isLoadingMore = false;
        let paginationMode = false;

        Object.keys(MENU_DATA).forEach(cat => {
            MENU_DATA[cat].forEach(item => {
                FLAT_ITEMS.push({ id: idCounter++, raw_name: item.n, price: item.p, image: item.i, cat });
            });
        });

        function renderCategories() {
            const container = safeGetById('categories-container');
            if (!container) return;
            container.innerHTML = Object.keys(MENU_DATA).map(cat => {
                const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
                return `
                    <button id="nav-${safeId}" onclick="selectCategory('${cat}')" 
                        class="category-btn whitespace-nowrap px-8 py-3.5 rounded-3xl text-sm font-black tracking-tight transition-all bg-gray-100 dark:bg-zinc-800 text-gray-500 dark:text-zinc-500">
                        ${translate(cat, 'cat')}
                    </button>
                `;
            }).join('');
        }

        function renderCategorySection(cat) {
            const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
            return `
                <div id="section-${safeId}" class="menu-section mb-10" data-category="${cat}">
                    <div class="px-6 mb-4">
                        <h2 class="text-xl font-black tracking-tighter text-gray-900 dark:text-white flex items-center gap-2">
                            <span class="w-1 h-6 bg-red-600 rounded-full"></span>
                            ${translate(cat, 'cat')}
                        </h2>
                    </div>
                    <div class="px-6 grid grid-cols-2 gap-3">
                        ${MENU_DATA[cat].map(item => renderProductCard(item)).join('')}
                    </div>
                </div>
            `;
        }

        function renderMenu(searchTerm = "") {
            const container = safeGetById('menu-sections');
            if (!container) return;
            if (searchTerm) {
                paginationMode = false;
                const filtered = FLAT_ITEMS.filter(i => translate(i.raw_name).toLowerCase().includes(searchTerm.toLowerCase()));

                if (searchResultsHeader) searchResultsHeader.classList.remove('hidden');
                if (searchResultCount) searchResultCount.textContent = `Found ${filtered.length} item${filtered.length !== 1 ? 's' : ''}`;

                const categories = [...new Set(filtered.map(i => i.cat))];
                if (searchFilters) {
                    searchFilters.classList.remove('hidden');
                    searchFilters.innerHTML = categories.map(cat => `
                        <button class="filter-chip" onclick="filterByCategory('${cat.replace(/'/g, "\\\\'")}', '${searchTerm.replace(/'/g, "\\\\'")}')">
                            ${translate(cat, 'cat')}
                        </button>
                    `).join('');
                }

                container.innerHTML = `<div class="px-6 grid grid-cols-2 gap-4">${filtered.map(item => renderProductCard(item)).join('')}</div>`;
                if (!filtered.length) container.innerHTML = `<div class="py-20 text-center text-gray-400 font-bold">${S.not_found}</div>`;

                return;
            }

            if (searchResultsHeader) searchResultsHeader.classList.add('hidden');
            if (searchFilters) searchFilters.classList.add('hidden');

            paginationMode = true;
            currentCategoryIndex = 0;
            container.innerHTML = '';

            for (let i = 0; i < CATEGORIES.length; i++) {
                const cat = CATEGORIES[i];
                const html = renderCategorySection(cat);
                container.innerHTML += html;
            }
            currentCategoryIndex = CATEGORIES.length;

            setTimeout(initScrollSpy, 100);
        }

        function loadMoreMenus(count = 2) {
            // No longer needed with new approach, but kept for compatibility
            if (isLoadingMore || !paginationMode) return;
            isLoadingMore = false;
        }

        function renderProductCard(item) {
            const rawName = item.raw_name || item.n;
            const name = translate(rawName);
            const price = item.p || item.price;
            const img = item.i || item.image;
            const optimizer = window.imageOptimizer;
            const optimizedImg = (optimizer && typeof optimizer.getOptimizedUrl === 'function')
                ? optimizer.getOptimizedUrl(img)
                : img;

            return `
                <div class="product-card bg-white dark:bg-[#1a1a1a] rounded-[45px] p-3 shadow-xl shadow-black/5 flex flex-col justify-between w-full h-full">
                    <div class="relative w-full aspect-square bg-gray-50 dark:bg-zinc-800 rounded-[38px] overflow-hidden">
                        <img 
                            data-src="${optimizedImg}" 
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Crect fill='%23f3f4f6' width='400' height='400'/%3E%3C/svg%3E"
                            alt="${name}"
                            class="w-full h-full object-cover image-zoom lazy"
                            onerror="this.onerror=null; this.src='images/burger.png';">
                        <button onclick="addToCartByName('${name.replace(/'/g, "\\'")}', ${price}, '${img}')" class="absolute bottom-2 right-2 w-9 h-9 price-tag rounded-full shadow-md shadow-red-500/30 flex items-center justify-center text-white active:scale-90 transition-all hover:scale-110">
                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3.5" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                        </button>
                    </div>
                    <div class="px-4 py-5">
                        <h3 class="font-black text-[12px] leading-tight tracking-tight text-gray-800 dark:text-zinc-100 line-clamp-2 h-8">${name}</h3>
                        <p class="text-red-500 font-extrabold text-[15px] mt-1 tracking-tighter">${price.toLocaleString()} so'm</p>
                    </div>
                </div>
            `;
        }

        function renderPromoCard(item) {
            const priceText = item.price ? item.price.toLocaleString() + " so'm" : '';
            const optimizer = window.imageOptimizer;
            const optimizedImg = (optimizer && typeof optimizer.getOptimizedUrl === 'function')
                ? optimizer.getOptimizedUrl(item.image)
                : item.image;

            return `
                <div class="promo-card" onclick="handlePromoClick('${item.id}')">
                    <img 
                        data-src="${optimizedImg}" 
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect fill='%23000' width='400' height='300'/%3E%3C/svg%3E"
                        alt="${item.name}"
                        class="lazy">
                    <div class="promo-card-overlay">
                        <div>
                            <span class="promo-card-badge">${item.badge}</span>
                        </div>
                        <div>
                            <p class="text-white text-base font-black mb-0.5">${item.label}</p>
                            <p class="promo-card-price">${priceText}</p>
                            <p class="text-[10px] text-white/70 font-bold">${item.subtext}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPromoGrid() {
            const container = document.getElementById('promo-grid');
            if (!container) return;
            container.innerHTML = PROMO_ITEMS.map(item => renderPromoCard(item)).join('');
        }

        window.handlePromoClick = (promoId) => {
            const promo = PROMO_ITEMS.find(item => item.id === promoId);
            if (!promo) return;
            addToCartByName(promo.label, promo.price, promo.image);
            if (tg?.HapticFeedback) tg?.HapticFeedback.impactOccurred('light');
        };

        window.addToCartByName = (name, price, image) => {
            const inCart = cart.find(i => i.name === name);
            if (inCart) inCart.quantity += 1;
            else cart.push({ name, price, image, quantity: 1, id: Date.now() });
            updateCartUI();
            if (tg?.HapticFeedback) tg?.HapticFeedback.impactOccurred('medium');
        }

        let isScrollingByClick = false;
        window.selectCategory = (cat) => {
            isScrollingByClick = true;
            updateActiveCategoryUI(cat);
            const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
            const el = document.getElementById(`section-${safeId}`);
            if (el) {
                const y = el.getBoundingClientRect().top + window.pageYOffset - 140;
                window.scrollTo({ top: y, behavior: "smooth" });
            }
            setTimeout(() => { isScrollingByClick = false; }, 800);
            if (tg?.HapticFeedback) tg?.HapticFeedback.selectionChanged();
        }

        function updateActiveCategoryUI(cat) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('category-active');
                btn.classList.add('bg-gray-100', 'dark:bg-zinc-800', 'text-gray-500', 'dark:text-zinc-500');
            });
            const safeId = cat.replace(/[^a-zA-Z0-9]/g, '');
            const activeBtn = document.getElementById(`nav-${safeId}`);
            if (activeBtn) {
                activeBtn.classList.add('category-active');
                activeBtn.classList.remove('bg-gray-100', 'dark:bg-zinc-800', 'text-gray-500', 'dark:text-zinc-500');
                activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }
        }

        function initScrollSpy() {
            const sections = document.querySelectorAll('.menu-section');
            const observer = new IntersectionObserver((entries) => {
                if (isScrollingByClick) return;
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.3) {
                        updateActiveCategoryUI(entry.target.getAttribute('data-category'));
                    }
                });
            }, { rootMargin: '-100px 0px -60% 0px' });
            sections.forEach(s => observer.observe(s));
        }

        const HEADER_OFFSET = 140;
        const AUTO_SCROLL_THRESHOLD = 200;
        let autoLastScrollY = window.scrollY;
        let autoScrollTimer = null;
        let autoScrolling = false;
        let lastAutoAdvanceTime = 0;

        function getNearestSection() {
            const sections = Array.from(document.querySelectorAll('.menu-section'));
            if (!sections.length) return null;
            let best = sections[0];
            let bestDist = Math.abs(best.getBoundingClientRect().top - HEADER_OFFSET);
            for (const sec of sections) {
                const rect = sec.getBoundingClientRect();
                const dist = Math.abs(rect.top - HEADER_OFFSET);
                if (dist < bestDist) { bestDist = dist; best = sec; }
            }
            return best;
        }

        function scrollToSection(section) {
            if (!section) return;
            autoScrolling = true;
            const y = section.offsetTop - HEADER_OFFSET;
            window.scrollTo({ top: y, behavior: 'smooth' });
            setTimeout(() => { autoScrolling = false; }, 1200);
        }

        function autoAdvanceIfNeeded() {
            if (isScrollingByClick || autoScrolling) return;
            const now = Date.now();
            // Increased minimum time between auto-advances (2 seconds)
            if (now - lastAutoAdvanceTime < 2500) return;

            const dirDown = window.scrollY > autoLastScrollY;
            autoLastScrollY = window.scrollY;
            if (!dirDown) return;

            const current = getNearestSection();
            if (!current) return;

            const bottomPosition = current.offsetTop + current.offsetHeight;
            const viewportBottom = window.scrollY + window.innerHeight;

            // Increased threshold so scroll completes fully before advancing
            if (viewportBottom < bottomPosition - AUTO_SCROLL_THRESHOLD) return;

            const sections = Array.from(document.querySelectorAll('.menu-section'));
            const idx = sections.indexOf(current);
            const next = idx >= 0 && idx < sections.length - 1 ? sections[idx + 1] : null;

            if (next) {
                lastAutoAdvanceTime = now;
                scrollToSection(next);
            }
        }

        window.addEventListener('scroll', () => {
            clearTimeout(autoScrollTimer);
            // Increased debounce delay from 200 to 400ms
            autoScrollTimer = setTimeout(autoAdvanceIfNeeded, 400);
        }, { passive: true });

        function updateCartUI() {
            const count = cart.reduce((sum, i) => sum + i.quantity, 0);
            const countEl = document.getElementById('cart-count');
            if (count > 0) {
                if (countEl) { countEl.innerText = count; countEl.classList.remove('hidden'); }
                // safe Telegram MainButton usage
                if (tg && tg.MainButton && typeof tg.MainButton.setText === 'function') {
                    try {
                        tg.MainButton.setText(`${S.confirm_btn} (${count})`);
                        if (typeof tg.MainButton.show === 'function') tg.MainButton.show();
                        if (typeof tg.MainButton.setParams === 'function') tg.MainButton.setParams({ color: '#dc2626', text_color: '#ffffff' });
                    } catch (e) { console.warn('tg.MainButton error', e); }
                }
            } else {
                if (countEl) countEl.classList.add('hidden');
                if (tg && tg.MainButton && typeof tg.MainButton.hide === 'function') {
                    try { tg.MainButton.hide(); } catch (e) { /* ignore */ }
                }
            }

            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            const deliveryFee = total >= DELIVERY_THRESHOLD ? 0 : BASE_DELIVERY_FEE;
            const finalTotal = total > 0 ? total + deliveryFee : 0;
            const deliveryMessage = total >= DELIVERY_THRESHOLD ? S.delivery_free : S.delivery_fee_note;

            document.getElementById('cart-total').innerHTML = `
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">${S.food_label}: ${total.toLocaleString()} so'm</p>
                    <p class="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-2">${S.deliv_label}: ${deliveryFee.toLocaleString()} so'm</p>
                    <p class="text-4xl font-black tracking-tighter text-red-600">${finalTotal.toLocaleString()} so'm</p>
                    <p class="text-[10px] font-bold uppercase tracking-widest mt-2 ${total >= DELIVERY_THRESHOLD ? 'text-emerald-500' : 'text-yellow-500'}">${deliveryMessage}</p>
                </div>`;
        }
        const modal = document.getElementById('cart-modal'),
            sheet = document.getElementById('cart-sheet'),
            overlay = document.getElementById('cart-overlay');

        function openCart() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                overlay.style.opacity = "1";
                sheet.classList.remove('translate-y-full');
            }, 10);
            renderCartItems();
            updateCartUI();
        }
        function closeCart() {
            overlay.style.opacity = "0";
            sheet.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 500);
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            let total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            if (cart.length === 0) {
                container.innerHTML = `<div class="py-10 text-center text-gray-400 font-bold">${S.cart_empty}</div>`;
            }
            else {
                container.innerHTML = cart.map(item => `
                    <div class="flex items-center gap-5 animate-item group">
                        <div class="w-16 h-16 rounded-2xl bg-gray-100 dark:bg-zinc-800 overflow-hidden shrink-0 shadow-md">
                            <img src="${item.image}" class="w-full h-full object-cover">
                        </div>
                        <div class="grow">
                            <h4 class="font-bold text-sm leading-tight text-gray-900 dark:text-white">${item.name}</h4>
                            <p class="text-red-500 font-extrabold text-sm mt-1">${item.price.toLocaleString()} so'm</p>
                        </div>
                        <div class="flex items-center gap-2 bg-gradient-to-r from-red-50 to-orange-50 dark:from-zinc-800 dark:to-zinc-700 rounded-2xl p-2 shadow-sm">
                            <button onclick="changeQty(${item.id}, -1)" class="w-8 h-8 rounded-lg bg-white dark:bg-zinc-600 shadow-sm flex items-center justify-center font-bold text-red-500 dark:text-red-400 hover:bg-red-50 dark:hover:bg-zinc-500 transition-colors">−</button>
                            <span class="text-sm font-black w-6 text-center text-gray-900 dark:text-white">${item.quantity}</span>
                            <button onclick="changeQty(${item.id}, 1)" class="w-8 h-8 rounded-lg bg-white dark:bg-zinc-600 shadow-sm flex items-center justify-center font-bold text-red-500 dark:text-red-400 hover:bg-red-50 dark:hover:bg-zinc-500 transition-colors">+</button>
                        </div>
                    </div>
                `).join('');
            }

            // Calculate discounts
            const quantityDiscount = applyQuantityDiscount(total, cart.reduce((sum, i) => sum + i.quantity, 0));
            const { totalDiscount, promoResult } = calculateFinalDiscount(
                total,
                window.currentPromoCode || '',
                cart.reduce((sum, i) => sum + i.quantity, 0),
                userData.isFirstTime
            );

            // Calculate delivery fee
            const deliveryConfig = calculateDeliveryFee(
                total - totalDiscount,
                window.currentDistance || null,
                window.currentZone || 'center',
                window.makeDeliveryOptional || false
            );

            const finalTotal = total > 0 ? (total - totalDiscount + deliveryConfig.fee) : 0;

            let discountHTML = '';
            if (quantityDiscount > 0) {
                discountHTML += `<p class="text-[11px] text-blue-500 font-bold uppercase mb-1">📦 Quantity discount: -${quantityDiscount.toLocaleString()} so'm</p>`;
            }
            if (promoResult.valid) {
                const promoDiscount = totalDiscount - quantityDiscount;
                discountHTML += `<p class="text-[11px] text-green-500 font-bold uppercase mb-1">🎁 ${promoResult.description}: -${promoDiscount.toLocaleString()} so'm</p>`;
            }

            document.getElementById('cart-total').innerHTML = `<div class="text-right">
                <p class="text-[10px] text-gray-500 font-bold uppercase mb-1">${S.food_label}: ${total.toLocaleString()} so'm</p>
                ${discountHTML}
                <p class="text-[10px] text-amber-600 dark:text-amber-400 font-bold uppercase mb-1">${S.deliv_label}: ${deliveryConfig.fee.toLocaleString()} so'm</p>
                <p class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-red-500 mt-2">${finalTotal.toLocaleString()} so'm</p>
                <p class="text-[10px] font-bold uppercase tracking-widest mt-2 ${total >= DELIVERY_THRESHOLD ? 'text-emerald-500' : 'text-amber-400'}">${deliveryConfig.reason}</p>
            </div>`;
        };

        // ===== HELPER FUNCTIONS & LOGIC =====
        let userData = {
            isFirstTime: true,
            totalOrders: 0,
            lastOrderDate: null
        };

        function loadCartFromStorage() {
            try {
                const stored = localStorage.getItem('yummy_cart_v2');
                return stored ? JSON.parse(stored) : [];
            } catch (e) { return []; }
        }

        function saveCartToStorage(cartData) {
            try {
                localStorage.setItem('yummy_cart_v2', JSON.stringify(cartData));
            } catch (e) { }
        }

        function saveUserData(data) {
            try {
                localStorage.setItem('yummy_user_data', JSON.stringify(data));
            } catch (e) { }
        }

        // Load on init
        try {
            const storedUser = localStorage.getItem('yummy_user_data');
            if (storedUser) userData = JSON.parse(storedUser);
        } catch (e) { }

        function calculateDeliveryFee(subtotal, distance, zone) {
            if (subtotal >= DELIVERY_THRESHOLD) return { fee: 0, isFree: true, reason: S.delivery_free };
            let fee = BASE_DELIVERY_FEE;
            if (distance && distance > 3) {
                fee += (distance - 3) * 1000;
            }
            return { fee: Math.round(fee), isFree: false, reason: S.delivery_fee_note };
        }

        function addToWishlist(name, price, image) {
            if (tg?.HapticFeedback) tg?.HapticFeedback.notificationOccurred('success');
            alert('Added to wishlist (Favorites coming soon!)');
        }

        function filterByCategory(cat, searchTerm) {
            // Implementation for filter chips
            const container = document.getElementById('menu-sections');
            paginationMode = false;
            const filtered = FLAT_ITEMS.filter(i =>
                (cat === 'all' || i.cat === cat) &&
                translate(i.raw_name).toLowerCase().includes(searchTerm.toLowerCase())
            );
            container.innerHTML = `<div class="px-6 grid grid-cols-2 gap-4">${filtered.map(item => renderProductCard(item)).join('')}</div>`;
        }

        window.changeQty = (id, delta) => {
            const idx = cart.findIndex(i => i.id === id);
            if (idx === -1) return;
            cart[idx].quantity += delta;
            if (cart[idx].quantity <= 0) cart.splice(idx, 1);
            saveCartToStorage(cart);
            renderCartItems();
            updateCartUI();
            if (cart.length === 0) closeCart();
            if (tg?.HapticFeedback) tg?.HapticFeedback.impactOccurred('light');
        }

        function promptPromoCode() {
            const code = prompt("Enter promo code:");
            if (code) {
                const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
                const result = validatePromoCode(code, total, userData.isFirstTime);
                if (result.valid) {
                    window.currentPromoCode = code;
                    alert(result.message);
                    renderCartItems(); // Recalculate totals
                } else {
                    alert(result.message);
                }
            }
        }

        // ===== CHECKOUT WITH LOCATION & PAYMENT =====
        const originalCheckout = document.getElementById('checkout-btn').onclick;
        document.getElementById('checkout-btn').onclick = () => {
            const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            const totalItems = cart.reduce((sum, i) => sum + i.quantity, 0);

            const { totalDiscount } = calculateFinalDiscount(total, window.currentPromoCode || '', totalItems, userData.isFirstTime);
            const deliveryConfig = calculateDeliveryFee(total - totalDiscount, window.currentDistance || null);
            const finalTotal = total > 0 ? (total - totalDiscount + deliveryConfig.fee) : 0;

            let confirmMsg = `📋 Buyurtma tasdiqlash:\n\n🍔 Taomlar: ${total.toLocaleString()} so'm\n`;
            if (totalDiscount > 0) confirmMsg += `✅ Chegirma: -${totalDiscount.toLocaleString()} so'm\n`;
            confirmMsg += `🚚 Yetkazish: ${deliveryConfig.fee.toLocaleString()} so'm\n\n💰 Jami: ${finalTotal.toLocaleString()} so'm`;

            if (!confirm(confirmMsg)) return;

            const payload = {
                type: 'order',
                items: cart,
                subtotal: total,
                discount: totalDiscount,
                delivery_fee: deliveryConfig.fee,
                total: finalTotal,
                userData: { isFirstTime: userData.isFirstTime, totalOrders: userData.totalOrders + 1 }
            };

            const send = () => {
                const checkoutBtn = document.getElementById('checkout-btn');
                if (checkoutBtn) checkoutBtn.disabled = true;
                setTimeout(() => {
                    // Update user data
                    userData.isFirstTime = false;
                    userData.totalOrders++;
                    userData.lastOrderDate = Date.now();
                    saveUserData(userData);

                    // Clear cart
                    cart = [];
                    saveCartToStorage(cart);

                    // Safe Telegram send/close
                    if (tg && typeof tg.sendData === 'function') {
                        try { tg.sendData(JSON.stringify(payload)); } catch (e) { console.warn('tg.sendData error', e); }
                    }
                    if (tg && typeof tg.close === 'function') {
                        try { tg.close(); } catch (e) { console.warn('tg.close error', e); }
                    }
                }, 500);
            };

            // Optionally get location
            if (navigator.geolocation && !window.makeDeliveryOptional) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        payload.location = {
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude,
                            accuracy: pos.coords.accuracy,
                            ts: Date.now()
                        };
                        window.userLocation = payload.location;

                        // Estimate delivery distance (simplified)
                        if (pos.coords.accuracy < 100) {
                            window.currentDistance = Math.round(pos.coords.accuracy / 1000 * 2) || 3;
                            updateCartUI();
                        }

                        try {
                            localStorage.setItem('yummy_last_geo', JSON.stringify(payload.location));
                        } catch (e) { }
                        send();
                    },
                    (err) => {
                        console.error("Geo error:", err);
                        send(); // Send anyway if geo fails
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
                );
            } else {
                // Try to load cached location
                try {
                    const cached = localStorage.getItem('yummy_last_geo');
                    if (cached) payload.location = JSON.parse(cached);
                } catch (e) { }
                send();
            }
        };

        // ===== DARK MODE TOGGLE =====
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        const THEME_STORAGE_KEY = 'yummy_theme';
        const themeIcon = document.getElementById('theme-icon');

        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                htmlElement.classList.add('dark');
                if (themeIcon) themeIcon.textContent = '☀️';
                if (tg && typeof tg.setHeaderColor === 'function') tg.setHeaderColor('#0f0f0f');
                if (tg && typeof tg.setBackgroundColor === 'function') tg.setBackgroundColor('#0c0c0c');
            } else {
                htmlElement.classList.remove('dark');
                if (themeIcon) themeIcon.textContent = '🌙';
                if (tg && typeof tg.setHeaderColor === 'function') tg.setHeaderColor('#ffffff');
                if (tg && typeof tg.setBackgroundColor === 'function') tg.setBackgroundColor('#fcfcfc');
            }
        }

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                htmlElement.classList.toggle('dark');
                const isDark = htmlElement.classList.contains('dark');
                localStorage.setItem(THEME_STORAGE_KEY, isDark ? 'dark' : 'light');
                if (themeIcon) themeIcon.textContent = isDark ? '☀️' : '🌙';

                if (isDark) {
                    tg.setHeaderColor('#0f0f0f');
                    tg.setBackgroundColor('#0c0c0c');
                } else {
                    tg.setHeaderColor('#ffffff');
                    tg.setBackgroundColor('#fcfcfc');
                }

                if (tg?.HapticFeedback) tg?.HapticFeedback.impactOccurred('light');
            });
        }

        // ===== INITIALIZE =====
        initTheme();
        cart = loadCartFromStorage();
        if (cart.length > 0) updateCartUI();

        if (tg && typeof tg.expand === 'function') {
            try { tg.expand(); } catch (e) { console.warn('tg.expand error', e); }
        }
        if (tg && typeof tg.ready === 'function') {
            try { tg.ready(); } catch (e) { console.warn('tg.ready error', e); }
        }

        renderCategories();
        renderPromoGrid();
        renderMenu();
    </script>
</body>

</html>